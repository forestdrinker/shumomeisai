# 1. Analysis & Model Selection (定调)

## Problem Classification

### Task 1
**Constrained inverse problem + hidden variable inference + uncertainty quantification**
*   **已知**: 评委分与真实淘汰/名次。
*   **未知**: 每周每人的观众票（或票份额）。
*   **要求**: 题目明确要求给出一致性 (Consistency) 与确定性 (Certainty) 指标。

### Task 2
**Counterfactual mechanism replay + discrete-event simulation + sensitivity & fairness evaluation**
*   **目标**: 用 Task 1 的票估计，在 Rank vs Percent（并可加入 Judges’ Save）下对每季重跑，并比较偏向性与争议人物命运。

## Data Strategy
必须在数据层面把“节目机制”可计算化（否则模型再高级也会崩）：
1.  **面板化**: 构建 $(s,t,i)$ 三维结构 (Season-Week-Contestant)。
2.  **数据截断处理**: 把淘汰后记录的 0 分视为 **右截断掩码**（不是“真实得分为0”），用于识别“当周是否仍在赛”。
3.  **缺失机制处理**:
    *   第 4 位评委缺席 $\rightarrow$ `weekX_judge4_score` 为 N/A。
    *   赛季未到某周 $\rightarrow$ 该周全是 N/A。
4.  **淘汰结构识别**: 允许“某周无人淘汰”与“某周多人淘汰”。
5.  **规则分段标签**:
    *   Rank: S1–2 and S28–34 (Reasonable assumption for S28 start).
    *   Percent: S3–27.

## Primary Model
**Constrained Bayesian dynamic vote-share model**
*   **核心**: 把每位选手每周的“人气潜变量”做动态随机游走，通过 softmax 生成票份额；再用“真实淘汰/名次”形成机制似然。
*   **选择理由**: 题目明确要 **Certainty**；贝叶斯/采样可以直接产出置信区间与周/人的不确定性差异（而不是硬给一个点）。
*   **CS 增强点**:
    *   用可微的 soft-rank 近似处理 rank 规则（避免硬排序导致不可导）。
    *   采用模块化 `SeasonSimulator` 支持“规则切换 + Save 情景 + Monte Carlo”。

## Baseline Model
**Week-wise CSP / Convex Selection Baseline**
*   **方法**: 每周独立地找一组票份额，使当周淘汰与历史一致；再用“最大熵/最小波动”挑一个代表解。
*   **作用**: 给主模型提供对照（证明“动态先验 + 不确定性传播”的增益），也作为 Debug 保险。

---

# 2. The Master Library (总库)

这里给 Coder 的“可执行说明书”：只给 **最小充分公式** 与 **结构化伪代码**。

## 2.1 Data Objects
对每个赛季 $s$、周 $t$、选手 $i$ 定义：

*   **评委总分** (跳过缺失评委):
    $$ S_{i,t} = \sum_{j\in\mathcal{J}_{s,t}} s_{i,t,j} $$
*   **在赛集合**:
    $$ \mathcal{A}_{s,t} = \{i:\ S_{i,t}>0\ \land\ \exists j,\ s_{i,t,j}\neq \text{N/A}\} $$
    *(注：淘汰后记 0 分是数据规则)*
*   **当周淘汰集合** (可为空或多于1人):
    $$ \mathcal{E}_{s,t} \subseteq \mathcal{A}_{s,t} $$
    *(由 results 字段解析得到)*
*   **规则指示变量**:
    $$ m_{s} \in \{\text{rank}, \text{percent}\} $$
*   **是否启用 Judges’ Save**:
    $$ \text{save}_s \in \{0,1\} $$

## 2.2 Voting Scheme Formulas

### Percent Rule
$$ p^J_{i,t} = \frac{S_{i,t}}{\sum_{k\in\mathcal{A}_{t}} S_{k,t}}, \qquad p^F_{i,t} = v_{i,t}, \qquad G_{i,t} = p^J_{i,t} + p^F_{i,t} $$
*   **淘汰**: $G_{i,t}$ 最低者（若多淘汰则取最低若干）。

### Rank Rule
令 $\mathrm{rank}_\downarrow(\cdot)$ 表示“数值越大 rank 越小（更好）”且 1 为最好：
$$ r^J_{i,t} = \mathrm{rank}_\downarrow(S_{i,t}), \qquad r^F_{i,t} = \mathrm{rank}_\downarrow(v_{i,t}), \qquad R_{i,t} = r^J_{i,t} + r^F_{i,t} $$
*   **淘汰**: $R_{i,t}$ 最高者（最差）。

## 2.3 Baseline Model for Task 1

**目标**: 得到一个点估计 $\hat v_{i,t}$，且尽量满足历史淘汰。

### Baseline Objective
*   **变量**: 每周票份额向量 $v_t=(v_{i,t})_{i\in\mathcal{A}_t}$
*   **约束**:
    $$ v_{i,t}\ge 0, \quad \sum_{i\in\mathcal{A}_t} v_{i,t}=1 $$
*   **一致性硬约束** (无 Save 情景的单淘汰版本):
    $$ G_{e,t} \le G_{k,t}-\epsilon, \quad \forall e\in\mathcal{E}_t,\ \forall k\in\mathcal{A}_t\setminus\mathcal{E}_t $$
    *(Rank 类似，用 $R$ 替换并改为 $\ge$)*
*   **多解选择准则** (推荐二选一):
    *   **最大熵**:
        $$ \max_{v_t}\ -\sum_{i\in\mathcal{A}_t} v_{i,t}\log v_{i,t} $$
    *   **最小波动 (跨周平滑)**:
        $$ \min_{v_t}\ \sum_{i\in\mathcal{A}_t}\left(v_{i,t}-\hat v_{i,t-1}\right)^2 $$

### Baseline Pseudo-code
*   **Step B1**: For each season $s$, initialize $\hat v_{i,1}$ uniform on $\mathcal{A}_{s,1}$.
*   **Step B2**: For $t=1..T_s$:
    *   Build active set $\mathcal{A}_{s,t}$, elimination set $\mathcal{E}_{s,t}$.
    *   If $|\mathcal{E}_{s,t}|=0$: set $\hat v_{t} \leftarrow \hat v_{t-1}$ (renormalize on active set).
    *   Else solve the constrained problem above to get $\hat v_t$.
*   **Step B3**: Output $\hat v_{i,t}$ and baseline consistency.

## 2.4 Primary Model for Task 1

**目标**: 得到票份额后验分布 $p(v_{i,t}\mid \text{data})$，可直接导出 Certainty。

### Latent Popularity Dynamics
对每位选手设潜变量 $u_{i,t}$（人气强度）：
$$ u_{i,1} \sim \mathcal{N}(0,\tau^2), \qquad u_{i,t} \mid u_{i,t-1} \sim \mathcal{N}(u_{i,t-1},\sigma_u^2) $$
并映射到票份额（在赛集合上 Softmax）：
$$ v_{i,t} = \frac{\exp(u_{i,t})}{\sum_{k\in\mathcal{A}_t}\exp(u_{k,t})} $$

### Soft-rank Surrogate for Rank Rule
为避免硬排序不可导，定义“软 Rank”（期望名次）：
$$ \tilde r^J_{i,t} = 1 + \sum_{k\in\mathcal{A}_t\setminus\{i\}} \sigma(\kappa_J(S_{k,t}-S_{i,t})) $$
$$ \tilde r^F_{i,t} = 1 + \sum_{k\in\mathcal{A}_t\setminus\{i\}} \sigma(\kappa_F(v_{k,t}-v_{i,t})) $$
$$ \tilde R_{i,t} = \tilde r^J_{i,t} + \tilde r^F_{i,t} $$
其中 $\sigma(x) = \frac{1}{1+e^{-x}}$。

### Unified Badness Score
定义“越大越差”的 Badness：
$$ b_{i,t} = \begin{cases} -(p^J_{i,t}+v_{i,t}), & m_s=\text{percent} \\ \tilde R_{i,t}, & m_s=\text{rank} \end{cases} $$

### Likelihood for Elimination
*   **单淘汰周**:
    $$ \Pr(e_t=i \mid b_t) = \frac{\exp(\lambda b_{i,t})}{\sum_{k\in\mathcal{A}_t}\exp(\lambda b_{k,t})} $$
*   **多淘汰周** ($|\mathcal{E}_t|=m$): 用 Plackett–Luce 最差 $m$ 人模型：
    $$ \Pr(\mathcal{E}_t \mid b_t) = \prod_{q=1}^{m} \frac{\exp(\lambda b_{e_q,t})}{\sum_{k\in\mathcal{A}_t\setminus\{e_1,\dots,e_{q-1}\}}\exp(\lambda b_{k,t})} $$

### Judges’ Save Modeling Option
给出两档实现：
*   **Option S1 硬约束版**:
    令 $\mathcal{B}_t$ 为 Badness 最大的两人 (Bottom-two)，要求 $e_t \in \mathcal{B}_t$。
*   **Option S2 概率版**:
    在 $e_t \in \mathcal{B}_t$ 基础上，用评委分差决定淘汰概率：
    $$ \Pr(e_t=i \mid \mathcal{B}_t=\{i,j\}) = \sigma(\gamma (S_{j,t}-S_{i,t})) $$

### Inference Plan
*   **Step P1**: 用 Baseline 输出作为初始化。
*   **Step P2**: 做 MAP 或 MCMC 估计 $u_{i,t}$ 的后验。
*   **Step P3**: 从后验采样得到 $\{v_{i,t}^{(r)}\}_{r=1}^R$。
*   **Step P4**: 输出均值/中位数/置信区间。

## 2.5 Task 1 Evaluation Metrics

*   **Consistency (淘汰复现率)**:
    $$ \mathrm{Acc} = \frac{1}{|\mathcal{T}_E|} \sum_{t\in\mathcal{T}_E} \mathbf{1}[\hat e_t=e_t] $$
*   **Rank Consistency (排名一致性)**:
    $$ \mathrm{RankErr} = \frac{1}{|\mathcal{T}_E|} \sum_{t\in\mathcal{T}_E} \mathrm{rank}_\uparrow(b_{e_t,t}) $$
*   **Certainty (置信区间)**:
    $$ U_{i,t} = Q_{0.95}(v_{i,t}) - Q_{0.05}(v_{i,t}) $$

## 2.6 Task 2 Mechanism Replay Engine

### Replay Strategies
*   **Replay-A 周内反事实 (Baseline)**: 每周独立比较，不传播未来影响。
*   **Replay-B 全赛季回放 (Primary)**:
    *   **Judge-score Imputer**: 预测反事实存活者的缺失分数 $\widehat S_{i,t}$。
    *   **Popularity Extrapolation**: 模拟未知 $u_{i,t}$。

### Task 2 Metrics Library
*   **Outcome Divergence**: 冠军改变率 $\Pr(\text{champion changes})$
*   **Fan-favor Index**:
    $$ \rho_F = \mathrm{Spearman}(\mathrm{rank}(v), \mathrm{rank}(\text{Placement})) $$
    $$ \rho_J = \mathrm{Spearman}(\mathrm{rank}(S), \mathrm{rank}(\text{Placement})) $$
*   **Upset Rate**: 评委 Rank 差但仍存活。
*   **Judges’ Save Impact**:
    $$ B_{i,t} = \mathrm{rank}_\downarrow(v_{i,t}) - \mathrm{rank}_\downarrow(S_{i,t}) $$

## 2.7 Replay-B Imputer Design

### Baseline Imputer
$$ \widehat S_{i,t} = \alpha S_{i,t^-} + (1-\alpha)\mu_{s,t} $$
*   $t^-$: 最近在赛周。

### ML Imputer (O奖加分)
*   **Predict**: 周内标准化分数 (Z-score) 或 $p^J_{i,t}$。
*   **Features**: 历史分、周次、剩余人数、Task 3 舞伴特征。
*   **Model**: LightGBM / XGBoost with Quantile Regression (输出不确定性)。

---

# 3. Visual & Table Library (工程诊断)

*   **Figures**:
    *   **Fig-D1**: Hard-constraint Feasibility Heatmap.
    *   **Fig-D2**: Soft-likelihood Trace / ESS plots.
    *   **Fig-D3**: Imputer Backfill Error Curve.
*   **Tables**:
    *   **Tab-D1**: 两版本参数表 ($\sigma_u, \lambda, \kappa, \gamma$)。
    *   **Tab-D2**: 收敛诊断 Checklist。
    *   **Tab-D3**: Imputer 性能 Performance。

# 4. Symbol Dictionary Additions

*   $\epsilon$: 硬约束裕量
*   $\lambda$: 淘汰 Softmax 尖锐度
*   $\kappa_J, \kappa_F$: 软 Rank 温度
*   $\sigma_u$: 人气随机游走方差
*   $\widehat S_{i,t}$: 补齐的评委分
*   $\widehat \sigma_{S,i,t}$: 补齐分数不确定性